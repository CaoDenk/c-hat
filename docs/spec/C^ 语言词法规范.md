# C^ 语言词法规范

本文档详细定义 C^ 语言的词法元素，包括Token类型、标识符规则、字面量格式等，为词法分析器提供精确规范。

## 1. 源文件编码

- **编码格式**: UTF-8 (无BOM)
- **换行符**: LF (`\n`) 或 CRLF (`\r\n`)
- **最大行长度**: 无限制（但建议不超过120字符）

## 2. 空白字符

以下字符被视为空白字符，用于分隔Token：

| 字符            | Unicode | 说明                       |
| --------------- | ------- | -------------------------- |
| ` ` (空格)      | U+0020  | 普通空格                   |
| `\t` (制表符)   | U+0009  | 水平制表符                 |
| `\n` (换行)     | U+000A  | 换行符                     |
| `\r` (回车)     | U+000D  | 回车符（与`\n`组合成CRLF） |
| `\f` (换页)     | U+000C  | 换页符                     |
| `\v` (垂直制表) | U+000B  | 垂直制表符                 |

**规则**: 空白字符在词法分析阶段被忽略，但用于分隔相邻的Token。

## 3. 注释

### 3.1 行注释

以 `//` 开始，到行尾结束。

```cpp
// 这是行注释
int x = 5; // 行尾注释
```

### 3.2 块注释

以 `/*` 开始，以 `*/` 结束，可以跨越多行。

```cpp
/* 这是块注释 */

/*
 * 多行块注释
 * 可以包含多行内容
 */

/* 块注释 /* 不支持嵌套 */ 这是错误 */
```

**规则**: 
- 块注释不支持嵌套
- 块注释内的所有内容（包括换行）都被视为注释

### 3.3 文档注释

以 `/**` 开始，用于生成API文档。

```cpp
/**
 * 计算两个数的和
 * @param a 第一个数
 * @param b 第二个数
 * @return 两数之和
 */
func add(int a, int b) -> int { ... }
```

## 4. 标识符

### 4.1 标识符规则

标识符用于命名变量、函数、类、模块等。

**语法规则**:
```
identifier ::= identifier_start identifier_continue*

identifier_start ::= 
    | 'a'..'z' | 'A'..'Z' | '_'
    | unicode_letter  // Unicode字母类别
    
identifier_continue ::= 
    | identifier_start
    | '0'..'9'
    | unicode_digit   // Unicode数字类别
```

**约束**:
- 不能以数字开头
- **不能以 `$` 开头**（`$` 是保留的特殊符号，用于倒序索引、字符串插值等）
- 不能是关键字（见关键字规范）
- 区分大小写
- 最大长度：无限制

### 4.2 有效标识符示例

```cpp
// 有效标识符
name
Name
_name
name123
名字  // Unicode支持
имя   // 俄语
名前  // 日语

// 无效标识符
123name    // 数字开头
$name      // 不能以 $ 开头（$ 是保留的特殊符号）
class      // 关键字
my-name    // 包含连字符
my.name    // 包含点号
```

### 4.3 命名约定（非强制）

| 类型                     | 约定                 | 示例                      |
| ------------------------ | -------------------- | ------------------------- |
| 类型名（类/结构体/枚举） | PascalCase           | `MyClass`, `HttpRequest`  |
| 函数名                   | camelCase            | `getValue`, `processData` |
| 变量名                   | camelCase            | `userName`, `totalCount`  |
| 常量                     | SCREAMING_SNAKE_CASE | `MAX_SIZE`, `PI`          |
| 私有成员                 | 下划线前缀           | `_internalValue`          |
| 模块名                   | snake_case           | `my_module`, `core_utils` |

## 5. 关键字

关键字是保留的标识符，不能用作普通标识符。完整关键字列表见《C^ 语言关键字规范》。

**关键字示例**:
```
func, class, struct, var, let, const, if, else, for, while,
return, new, delete, self, base, import, export, ...
```

## 6. 字面量

### 6.1 整数字面量

#### 6.1.1 十进制整数

```
decimal_literal ::= decimal_digit+
decimal_digit   ::= '0' | '1' | '2' | '3' | '4' | '5' | '6' | '7' | '8' | '9'
```

**示例**: `0`, `42`, `1234567890`

#### 6.1.2 十六进制整数

```
hex_literal     ::= '0x' hex_digit+ | '0X' hex_digit+
hex_digit       ::= decimal_digit | 'a'..'f' | 'A'..'F'
```

**示例**: `0x0`, `0xFF`, `0xDEADBEEF`, `0Xabc`

#### 6.1.3 二进制整数

```
binary_literal  ::= '0b' binary_digit+ | '0B' binary_digit+
binary_digit    ::= '0' | '1'
```

**示例**: `0b0`, `0b1010`, `0B11110000`

> **注意**：C^ 不支持八进制字面量。

#### 6.1.4 整数后缀

```
integer_suffix  ::= 'u' | 'U' | 'l' | 'L' | 'ul' | 'UL' | 'lu' | 'LU'
```

| 后缀      | 类型    | 示例   |
| --------- | ------- | ------ |
| 无后缀    | `int`   | `42`   |
| `u`/`U`   | `uint`  | `42u`  |
| `l`/`L`   | `long`  | `42L`  |
| `ul`/`UL` | `ulong` | `42UL` |

### 6.2 浮点数字面量

#### 6.2.1 小数形式

```
decimal_float   ::= decimal_digit+ '.' decimal_digit* exponent?
                  | '.' decimal_digit+ exponent?
                  | decimal_digit+ exponent

exponent        ::= ('e' | 'E') ('+' | '-')? decimal_digit+
```

**示例**: `3.14`, `.5`, `1e10`, `2.5E-3`

#### 6.2.2 十六进制浮点数

```
hex_float       ::= '0x' hex_digit+ '.' hex_digit* hex_exponent
                  | '0X' hex_digit+ '.' hex_digit* hex_exponent

hex_exponent    ::= ('p' | 'P') ('+' | '-')? decimal_digit+
```

**示例**: `0x1.5p10`, `0xFF.0p-4`

#### 6.2.3 浮点后缀

| 后缀      | 类型     | 示例     |
| --------- | -------- | -------- |
| 无后缀    | `double` | `3.14`   |
| `f`/`F`   | `float`  | `3.14f`  |
| `h`/`H`   | `fp16`   | `3.14h`  |
| `bf`/`BF` | `bf16`   | `3.14bf` |

### 6.3 字符字面量

#### 6.3.1 单字符

```
char_literal    ::= '\'' (single_char | escape_sequence) '\''
single_char     ::= 任何非 `'` 和 `\` 且非换行的字符
```

**示例**: `'a'`, `'中'`, `'\n'`, `'\\'`, `'\''`

#### 6.3.2 ASCII转义序列

| 转义序列 | 含义     | Unicode |
| -------- | -------- | ------- |
| `\n`     | 换行     | U+000A  |
| `\r`     | 回车     | U+000D  |
| `\t`     | 制表符   | U+0009  |
| `\\`     | 反斜杠   | U+005C  |
| `\'`     | 单引号   | U+0027  |
| `\"`     | 双引号   | U+0022  |
| `\0`     | 空字符   | U+0000  |
| `\a`     | 响铃     | U+0007  |
| `\b`     | 退格     | U+0008  |
| `\f`     | 换页     | U+000C  |
| `\v`     | 垂直制表 | U+000B  |

#### 6.3.3 Unicode转义序列

```
unicode_escape  ::= '\u{' hex_digit+ '}'
```

**示例**: `'\u{0041}'` (A), `'\u{4E2D}'` (中)

### 6.4 字符串字面量

#### 6.4.1 普通字符串

```
string_literal  ::= '"' (string_char | escape_sequence)* '"'
string_char     ::= 任何非 `"` 和 `\` 且非换行的字符
```

**示例**: `"hello"`, `"line1\nline2"`, `"say \"hello\""`

#### 6.4.2 原始字符串 (Raw String)

使用前后对称的 `#` 符号作为定界符，支持包含未转义字符。

```
raw_string      ::= '#"' raw_content '"#'
raw_content     ::= 任何字符序列 (需配对结束符)
```

**示例**: `#"C:\Users\name"#`（不处理转义，支持多行）

#### 6.4.3 自定义字面量前缀

C^ 支持通过**标识符前缀**来扩展字符串字面量的语义。任何标识符紧接字符串字面量（无空格）均被视为带有前缀的字面量调用。

```
prefixed_string ::= identifier string_literal
                  | identifier raw_string
```

**示例**:
```cpp
// 正则表达式 (标准库 std.regex 实现)
var p = regex"\d+"; 

// JSON 对象 (假设第三方库实现)
var j = json#"{"k": "v"}"#;
```

#### 6.4.4 多行字符串 (String Block)

使用三个双引号 `"""` 包围的文本块，自动处理缩进和换行。

```
multiline_string ::= '"""' multiline_content '"""'
```

**示例**:
```cpp
"""
这是多行
字符串
可以包含"引号"和\反斜杠\而不转义
"""
```

#### 6.4.4 字符串插值

```cpp
var name = "World";
var message = "Hello, ${name}!";  // "Hello, World!"
var calc = "1 + 2 = ${1 + 2}";    // "1 + 2 = 3"
```

#### 6.4.5 字符串字面量类型

字符串字面量的默认类型为 `std.literal_view`，这是一个标记类型，保证指向的数据拥有静态生命周期（存储在 `.rodata` 段）。

**类型转换**：
- `std.literal_view` 可以隐式转换为 `string` 类型
- `std.literal_view` 可以隐式转换为 `byte[]` 切片
- `std.literal_view` 是不可变的，不能修改其内容

**示例**：
```cpp
// 字符串字面量默认为 std.literal_view
var s = "hello"; // 类型为 std.literal_view

// 隐式转换为 string
string str = "hello"; // std.literal_view -> string

// 隐式转换为 byte[] 切片
byte[] bytes = "hello"; // std.literal_view -> byte[]

// 不能修改字符串字面量
// s[0] = 'H'; // 编译错误：std.literal_view 是不可变的
```

### 6.5 布尔字面量

```
boolean_literal ::= 'true' | 'false'
```

### 6.6 空指针字面量

```
null_literal    ::= 'null'
```

## 7. 操作符和分隔符

### 7.1 单字符操作符

| 操作符 | 名称     | 用途                 |
| ------ | -------- | -------------------- |
| `+`    | 加号     | 加法、正号           |
| `-`    | 减号     | 减法、负号           |
| `*`    | 星号     | 乘法、解引用         |
| `/`    | 斜杠     | 除法                 |
| `%`    | 百分号   | 取模                 |
| `&`    | 与号     | 按位与、取地址       |
| `\|`   | 竖线     | 按位或               |
| `^`    | 脱字符   | 按位异或、指针类型   |
| `~`    | 波浪号   | 按位取反、析构       |
| `!`    | 感叹号   | 逻辑非、不可变修饰   |
| `=`    | 等号     | 赋值                 |
| `<`    | 小于     | 小于比较             |
| `>`    | 大于     | 大于比较             |
| `?`    | 问号     | 可空类型、条件表达式 |
| `:`    | 冒号     | 类型标注、条件表达式 |
| `.`    | 点号     | 成员访问             |
| `,`    | 逗号     | 分隔符               |
| `;`    | 分号     | 语句结束             |
| `(`    | 左圆括号 | 分组、函数调用       |
| `)`    | 右圆括号 | 分组、函数调用       |
| `{`    | 左花括号 | 代码块               |
| `}`    | 右花括号 | 代码块               |
| `[`    | 左方括号 | 数组索引、切片       |
| `]`    | 右方括号 | 数组索引、切片       |
| `$`    | 美元号   | 特殊语法（如栈数组） |

### 7.2 多字符操作符

| 操作符 | 名称     | 用途                 |
| ------ | -------- | -------------------- |
| `++`   | 自增     | 递增                 |
| `--`   | 自减     | 递减                 |
| `==`   | 等于     | 相等比较             |
| `!=`   | 不等于   | 不等比较             |
| `<=`   | 小于等于 | 小于等于比较         |
| `>=`   | 大于等于 | 大于等于比较         |
| `&&`   | 逻辑与   | 短路与               |
| `\|\|` | 逻辑或   | 短路或               |
| `<<`   | 左移     | 位左移               |
| `>>`   | 右移     | 位右移               |
| `+=`   | 加赋值   | 加法赋值             |
| `-=`   | 减赋值   | 减法赋值             |
| `*=`   | 乘赋值   | 乘法赋值             |
| `/=`   | 除赋值   | 除法赋值             |
| `%=`   | 模赋值   | 取模赋值             |
| `&=`   | 与赋值   | 按位与赋值           |
| `\|=`  | 或赋值   | 按位或赋值           |
| `^=`   | 异或赋值 | 按位异或赋值         |
| `<<=`  | 左移赋值 | 左移赋值             |
| `>>=`  | 右移赋值 | 右移赋值             |
| `->`   | 箭头     | 返回值类型、成员访问 |
| `=>`   | 胖箭头   | 匹配分支、Lambda     |
| `::`   | 双冒号   | 命名空间/模块访问    |
| `..`   | 双点     | 范围操作符           |
| `...`  | 三点     | 变参、展开           |
| `??`   | 空合并   | 空合并运算符         |
| `^`    | 取地址   | 取地址操作符（前缀） |

### 7.3 最大 munch 原则

词法分析采用**最大 munch**（最长匹配）原则：当多个操作符可以匹配时，选择最长的匹配。

**示例**:
- `>>=` 匹配为一个操作符，而不是 `>>` 和 `=`
- `...` 匹配为一个操作符，而不是 `..` 和 `.`

## 8. 预处理指令（预留）

C^ 语言目前不支持C风格的预处理指令。相关功能通过编译期计算和元编程实现。

## 9. 词法错误

### 9.1 错误类型

| 错误代码 | 描述           | 示例                   |
| -------- | -------------- | ---------------------- |
| LEX001   | 非法字符       | `@`, `#`（在非法位置） |
| LEX002   | 未终止的字符串 | `"hello`               |
| LEX003   | 未终止的块注释 | `/* 没有结束`          |
| LEX004   | 非法转义序列   | `"\q"`                 |
| LEX005   | 非法数字格式   | `0xGGG`, `0b2`         |
| LEX006   | 数字溢出       | 超出类型范围的整数     |
| LEX007   | 非法标识符     | `123abc`               |

### 9.2 错误恢复策略

1. **非法字符**: 跳过该字符，继续分析
2. **未终止的字符串**: 在行尾自动终止，报告错误
3. **未终止的块注释**: 在文件结束处终止，报告错误
4. **非法转义序列**: 将反斜杠视为普通字符，报告错误

## 10. Token 类型枚举

完整的Token类型定义见 `src/lexer/TokenType.h`。

主要Token类别：
- `Keyword`: 关键字
- `Identifier`: 标识符
- `Literal`: 字面量（整数、浮点、字符、字符串、布尔、null）
- `Operator`: 操作符
- `Delimiter`: 分隔符
- `Comment`: 注释
- `Whitespace`: 空白字符
- `EndOfFile`: 文件结束

## 11. 版本历史

| 版本 | 日期    | 变更                     |
| ---- | ------- | ------------------------ |
| 1.0  | 2025-02 | 初始版本                 |
| 1.1  | 2025-02 | 添加 `bf16` 浮点类型后缀 |
