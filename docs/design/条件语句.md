# C^ 条件语句设计文档

## 1. if-else 语句

### 1.1 基本语法

```cpp
if (condition) {
    // 条件为真时执行
} else if (condition2) {
    // 条件1为假，条件2为真时执行
} else {
    // 所有条件为假时执行
}
```

### 1.2 条件表达式

* **严格布尔类型**：C^ 采用严格的布尔检查。
* **禁止隐式转换**：数值类型和指针类型**不能**直接作为条件，必须显式比较。

```cpp
// 布尔表达式
if (x > 0) {
    // 执行
}

// 数值类型 (强制显式比较)
// if (x) { } // Error
if (x != 0) {
    // x 不为 0 时执行
}

// 指针类型 (强制显式比较)
// if (ptr) { } // Error
if (ptr != null) {
    // ptr 不为 null 时执行
}
```

### 1.3 单行语句

* **省略大括号**：当只有一条语句时，可以省略大括号
* **建议**：为了代码可读性和避免错误，建议始终使用大括号

```cpp
if (condition)
    statement; // 单行语句
else
    statement; // 单行语句

// 推荐写法
if (condition) {
    statement;
} else {
    statement;
}
```

### 1.4 嵌套 if-else

* **嵌套层级**：可以无限嵌套，但建议控制在 3-4 层以内
* **可读性**：对于复杂条件，考虑使用 switch 语句或提取为函数

```cpp
if (x > 0) {
    if (x < 10) {
        // 0 < x < 10
    } else {
        // x >= 10
    }
} else {
    // x <= 0
}
```

## 2. Match 模式匹配

C^ 移除了传统的 `switch` 语句，引入了更强大、更安全的 `match` 表达式。

### 2.1 基本语法

`match` 是一个表达式（Expression），这意味着它有返回值。

```cpp
var result = match (expression) {
    case pattern1 => value1,
    case pattern2 => value2,
    case _        => default_value // 通配符/Default
};
```

### 2.2 模式匹配类型

#### 2.2.1 常量与字面量
支持整数、浮点数、字符、**字符串**等字面量匹配。

```cpp
// 字符串匹配 (编译器优化为哈希跳转)
match (command) {
    case "start" => start_game(),
    case "quit"  => exit_game(),
    case _       => print("Unknown command")
}
```

#### 2.2.2 穿透 (Fallthrough)
`match` 默认**不穿透**。如果需要多个模式执行同一逻辑，使用 `|` 组合模式。

```cpp
match (char_code) {
    case 'a' | 'A' => print("Ace"),
    case 'k' | 'K' => print("King"),
    case _         => print("Other")
}
```

#### 2.2.3 范围匹配
使用 `..` 匹配范围。

```cpp
match (score) {
    case 90..100 => "A",
    case 80..89  => "B",
    case 0..79   => "C",
    case _       => "Invalid"
}
```

#### 2.2.4 结构解构 (Destructuring)
可以解构对象或元组。

```cpp
match (point) {
    case Point(0, 0) => "Origin",
    case Point(x, 0) => "On X-axis at " + x,
    case Point(0, y) => "On Y-axis at " + y,
    case Point(x, y) => $"({x}, {y})"
}
```

#### 2.2.5 守卫子句 (Guards)
使用 `if` 增加额外判断条件。

```cpp
match (num) {
    case x if x % 2 == 0 => "Even",
    case _               => "Odd"
}
```

### 2.3 穷尽性检查 (Exhaustiveness)
`match` 必须覆盖所有可能的情况。对于枚举类型，如果未覆盖所有成员且没有 `_` 分支，编译器会报错。

```cpp
enum Color { Red, Green, Blue }

// 编译错误：未覆盖 Blue
// match (color) {
//     Red   => ...
//     Green => ...
// }
```

## 3. 三元运算符

### 3.1 基本语法

```cpp
expression ? true_expression : false_expression
```

### 3.2 用法

* **简洁赋值**：用于根据条件选择不同的值
* **表达式**：整个三元运算符是一个表达式，可以作为其他表达式的一部分

```cpp
// 基本用法
int max = a > b ? a : b;

// 嵌套使用
int result = x > 0 ? 1 : (x < 0 ? -1 : 0);

// 作为表达式的一部分
printf("Result: %d\n", condition ? value1 : value2);
```

### 3.3 注意事项

* **可读性**：避免过度嵌套三元运算符
* **类型一致性**：true_expression 和 false_expression 的类型应保持一致
* **副作用**：表达式中的副作用会根据条件执行

## 4. 逻辑运算符与条件组合

### 4.1 短路求值

* **&& 运算符**：如果左侧为 false，右侧不会求值
* **|| 运算符**：如果左侧为 true，右侧不会求值

```cpp
// 短路求值
if (ptr != null && ptr^ > 0) {
    // 只有 ptr 不为 null 时才会解引用
}

if (x == 0 || y / x > 1) {
    // 只有 x != 0 时才会执行除法
}
```

### 4.2 条件组合

* **优先级**：&& 优先级高于 ||
* **括号**：使用括号明确优先级

```cpp
// 优先级
if (a && b || c) {
    // 等价于 (a && b) || c
}

// 使用括号
if (a && (b || c)) {
    // 明确优先级
}
```

## 5. 条件语句的性能考虑

### 5.1 分支预测

* **预测成功率**：编译器和 CPU 会预测分支走向
* **性能影响**：预测失败会导致流水线停顿
* **优化建议**：
  - 把最可能执行的分支放在前面
  - 避免复杂的条件判断
  - 对于有序数据，使用二分查找替代多个 if-else

### 5.2 match vs if-else

* **match 优势**：
  - **穷尽性检查**：防止漏掉枚举情况
  - **模式匹配**：支持解构、类型匹配等高级功能
  - **表达式**：可以直接作为返回值
  - **性能**：编译器可优化为跳转表或决策树
* **if-else 优势**：
  - 对于简单的布尔条件更直观
* **选择建议**：
  - 涉及枚举、多态类型判断、复杂模式时优先使用 match
  - 简单的二元判断使用 if-else

## 6. 最佳实践

1. **优先使用 match**：替代复杂的 if-else if 链
2. **条件简洁性**：条件表达式应简洁明了
3. **括号使用**：使用括号明确逻辑关系
4. **大括号使用**：即使单行语句也建议使用大括号
5. **分支顺序**：把最可能执行的分支放在前面
6. **复杂条件**：将复杂条件提取为布尔变量或函数
7. **默认分支**：match 语句中添加 _ 分支处理兜底
8. **避免深度嵌套**：控制 if-else 嵌套层级
9. **三元运算符**：仅用于简单的条件赋值

```cpp
// 不好的写法
if (x > 0 && y < 10 || z == 5) {
    // 执行
}

// 好的写法
bool condition = (x > 0) && (y < 10) || (z == 5);
if (condition) {
    // 执行
}

// 更好的写法
bool is_valid_range() {
    return (x > 0) && (y < 10);
}

bool is_special_case() {
    return z == 5;
}

if (is_valid_range() || is_special_case()) {
    // 执行
}
```

C^ 的条件语句设计与 C/C++ 类似，但增加了一些现代语言特性，如类型安全检查和更清晰的语法。合理使用条件语句可以使代码逻辑清晰，性能高效。