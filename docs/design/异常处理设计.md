# 异常处理设计文档

## 日期
2026-02-18

## 设计目标
C^ 语言的异常处理系统需要：
1. **不绑定标准库** - 即使没有标准库，语言本身也应该具备抛出和捕获异常的能力
2. **与现有类型系统一致** - 异常可以是任何类型，不仅仅是特定标准库类型
3. **简单且高效** - 异常处理不应该带来过度的性能开销

---

## 核心设计原则

### 1. 异常可以是任何类型
C^ 语言不要求异常必须派生于特定的基类（如 `std::exception`）。异常可以是：
- 基本类型（`int`、`string` 等）
- 自定义类或结构体
- 任何其他类型

### 2. 不绑定标准库
异常处理是语言的核心特性，与标准库无关：
- 即使没有标准库，用户也可以抛出和捕获基本类型异常
- 标准库可以提供 `std::exception` 基类，但这是可选的
- 语言本身不依赖于标准库的异常类型

### 3. 与 LiteralView 一致的设计
字符串类型使用 `LiteralView` 作为编译期字面量视图类型，属于语言核心，不依赖标准库。异常处理遵循相同理念：
- 异常类型可以是语言内置类型，如 `LiteralView`、`int` 等
- 标准库可以提供更高级的异常类型，但不强制使用

---

## 语法设计

### 抛出异常
```cpp
throw expression;
```

示例：
```cpp
// 抛出基本类型
throw 42;

// 抛出字符串字面量（LiteralView）
throw "Error occurred";

// 抛出自定义类型
struct MyError {
    int code;
    LiteralView message;
};

throw MyError{404, "Not found"};
```

### 捕获异常
```cpp
try {
    // 可能抛出异常的代码
} catch (Type1 var1) {
    // 处理 Type1 类型的异常
} catch (Type2 var2) {
    // 处理 Type2 类型的异常
} catch (...) {
    // 捕获所有异常（可选）
}
```

示例：
```cpp
try {
    funcThatMayThrow();
} catch (int errorCode) {
    println("Error code: ", errorCode);
} catch (LiteralView errorMsg) {
    println("Error: ", errorMsg);
} catch (MyError err) {
    println("Error ", err.code, ": ", err.message);
}
```

---

## 类型系统与异常

### 异常类型匹配规则
1. **精确类型匹配** - 优先匹配完全相同的类型
2. **基类匹配**（如果支持继承）- 可以捕获派生类异常
3. **通用捕获** - `catch (...)` 捕获所有未匹配的异常

### 异常与现有类型系统的整合
- 异常类型是正常的类型，参与类型检查
- 不需要特殊的异常类型声明
- 与 `LiteralView`、`Slice` 等语言核心类型完全兼容

---

## 无标准库场景

### 最小异常处理示例
即使没有标准库，也可以使用异常：
```cpp
module minimal_exception;

func divide(int a, int b) -> int {
    if (b == 0) {
        throw -1;
    }
    return a / b;
}

func main() {
    try {
        int result = divide(10, 0);
        println("Result: ", result);
    } catch (int error) {
        println("Error: division by zero");
    }
}
```

### 使用 LiteralView 的异常
```cpp
module literalview_exception;

func validate(int value) {
    if (value < 0) {
        throw "Value must be positive";
    }
}

func main() {
    try {
        validate(-5);
    } catch (LiteralView msg) {
        println(msg);
    }
}
```

---

## 标准库的角色（可选）

标准库可以提供但不强制：
1. `std::exception` 基类
2. 常见异常类型（`std::runtime_error`、`std::logic_error` 等）
3. 异常辅助函数

但语言核心不依赖于这些。

---

## 与 C++ 异常的区别
| 特性 | C++ | C^ |
|------|-----|-----|
| 异常基类要求 | 可以派生于 `std::exception`（但非强制） | **无要求**，任何类型都可以 |
| 标准库绑定 | 异常处理与标准库有一定耦合 | **完全解耦**，无标准库也可使用 |
| 字符串异常 | `std::string`（标准库类型） | `LiteralView`（语言核心类型） |

---

## 结论

C^ 语言的异常处理系统设计：
1. ✅ **不绑定标准库** - 语言核心支持异常处理
2. ✅ **异常可以是任何类型** - 包括基本类型和自定义类型
3. ✅ **与 LiteralView 等核心类型一致** - 遵循相同的设计理念
4. ✅ **简单高效** - 避免了不必要的复杂性

这种设计确保了语言的灵活性和独立性，同时为标准库提供了扩展空间。
