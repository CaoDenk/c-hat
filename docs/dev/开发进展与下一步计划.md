# C-Hat 开发进展与下一步计划

## 目录
1. [当前进展](#当前进展)
2. [已完成功能](#已完成功能)
3. [下一步计划](#下一步计划)
4. [优先级](#优先级)

---

## 当前进展

### 最新更新日期
2026-02-18

### 当前状态
项目基础功能已基本完善，正在进行高级特性开发。

---

## 已完成功能

### 1. 基础编译器组件 ✅
- **词法分析器 (Lexer)**
  - 完整的词法分析
  - 支持所有基本 token 类型
  - 支持字符串、数字、标识符等

- **语法分析器 (Parser)**
  - 完整的语法分析
  - 支持所有基本语句和表达式
  - AST 节点生成

- **语义分析器 (Semantic Analyzer)**
  - 类型检查
  - 符号表管理
  - 作用域处理

- **LLVM 代码生成器**
  - 基础 LLVM IR 生成
  - 函数生成
  - 变量声明和初始化

### 2. 类型系统 ✅
- **基础类型**
  - 整数族：byte/sbyte/short/ushort/int/uint/long/ulong
  - 浮点族：float/double/fp16/bf16
  - 字符/布尔：char/bool
  - void 类型
  - literal_view（语言内置的字面量承载类型）

- **复合类型**
  - 数组类型 (值类型，默认在栈上：T[N])
  - 切片类型 (视图类型：T[])
  - 指针类型 (T^)
  - 元组类型 (值类型，默认在栈上)
  - 类类型
  - 结构体类型

- **类型修饰符**
  - ! 修饰符 (内容不可变：T!)
  - late 关键字 (延迟初始化)

### 3. 表达式和语句 ✅
- **表达式**
  - 基本算术表达式
  - 逻辑表达式
  - 比较表达式
  - 函数调用
  - 成员访问
  - 数组下标访问
  - 一元表达式 (取地址、解引用等)
  - new 表达式 (分配堆内存，调用构造函数)
  - delete 表达式 (调用析构函数，释放内存)

- **语句**
  - 表达式语句
  - 复合语句 (块)
  - if-else 语句
  - while 循环
  - for 循环
  - break/continue
  - return 语句
  - defer 语句 (延迟执行)
  - try-catch 语句 (解析和语义分析完成)
  - throw 语句 (解析和语义分析完成)

### 4. 声明 ✅
- **变量声明**
  - 显式类型声明
  - var/let 类型推导
  - late 关键字支持
  - 初始化器支持

- **函数声明**
  - 普通函数
  - 箭头函数 (=> 语法)
  - 参数列表
  - 返回类型

- **类声明**
  - 类定义
  - 成员变量
  - 成员方法
  - 构造函数 (与类名相同)
  - 析构函数 (~ 开头)
  - self 指针 (不是 this)
  - 继承支持 (extends)

- **结构体声明**
  - 结构体定义
  - 成员变量

- **扩展声明**
  - 扩展现有类型
  - 添加成员变量和方法

- **类型别名**
  - type alias 支持

### 5. 方案B实现 ✅
根据方案B的设计，完成了以下实现：
- 数组和元组都是值类型，默认在栈上
- 视图类型需要显式声明
- 移除了 Type[$] 语法
- 统一了字面量推导规则
- 所有设计文档已更新

### 6. new/delete 表达式 ✅
- **new 表达式**
  - 调用 malloc 分配堆内存
  - 如果是类类型，调用构造函数
  - 返回类型指针

- **delete 表达式**
  - 调用 free 释放堆内存
  - (待完善：调用析构函数)

### 7. 构造函数和析构函数 ✅
- **构造函数**
  - 与类名相同的函数
  - 返回 void
  - 第一个参数是 self 指针
  - 命名规则：`ClassName_ClassName`

- **析构函数**
  - 以 ~ 开头的函数
  - 返回 void
  - 第一个参数是 self 指针
  - 命名规则：`ClassName_~ClassName`

- **成员函数**
  - 第一个参数是 self 指针
  - 命名规则：`ClassName_MethodName`

### 8. late 关键字 ✅
- 解析器支持解析 late 关键字
- 语义分析器支持 isLate 标志
- 代码生成器支持，不强制要求初始值
- 用于延迟初始化场景

### 9. 测试 ✅
- parser_test：测试解析功能
- semantic_test：测试语义分析功能
- 涵盖所有主要功能点

---

## 下一步计划

### 高优先级
1. **完善异常处理的 LLVM 代码生成 (invoke/landingpad)** ⚠️
   - 使用 LLVM 的 invoke 指令
   - 使用 landingpad 机制
   - 支持 try-catch 的完整代码生成

2. **完善 delete 表达式**
   - 在释放内存之前调用析构函数
   - 支持析构函数的查找和调用

3. **完善成员函数调用**
   - 支持指针类型的成员访问 (p->member)
   - 支持堆对象的成员函数调用

4. **完善数组字面量的代码生成**
   - 支持非字面量元素的数组初始化
   - 支持运行时数组初始化

### 中优先级
5. **完善异常处理的完整实现**
   - 支持 catch(...) 兜底方案
   - 支持异常类型匹配
   - 支持异常传播

6. **实现切片的完整功能**
   - 切片的 len 属性
   - 切片的 ptr 属性
   - 切片的下标访问

7. **完善类系统**
   - 实现继承的代码生成
   - 实现虚函数支持
   - 实现多态

8. **标准库基础**
   - 实现 println 函数
   - 实现基础字符串操作
   - 实现基础数学函数

### 低优先级
9. **优化**
   - 代码优化
   - 编译速度优化
   - 运行时性能优化

10. **更多测试**
    - 集成测试
    - 性能测试
    - 边界条件测试

---

## 优先级

### 立即执行 (本周内)
1. 完善异常处理的 LLVM 代码生成 (invoke/landingpad)
2. 完善 delete 表达式 (调用析构函数)
3. 完善成员函数调用 (指针类型)

### 短期 (1-2周)
4. 完善异常处理的完整实现
5. 实现切片的完整功能
6. 完善类系统 (继承、虚函数)

### 中期 (1个月)
7. 标准库基础
8. 更多测试
9. 优化

---

## 备注

- 所有设计文档已更新到 docs/design/ 目录
- 构建教程在 docs/build/build.md
- 项目使用 CMake 构建系统
- 依赖 LLVM 17+
