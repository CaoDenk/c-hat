# C^ (C-Hat) 构建系统

## 1. 概述

构建系统是C^语言编译器开发的重要组成部分，负责管理项目的编译、链接和依赖关系。本文档详细描述了C^语言的构建系统设计，包括构建工具、构建流程、构建配置、依赖管理和构建优化等内容。

### 1.1 构建目标

- **高效构建**：快速编译和链接
- **跨平台**：支持Windows、Linux和macOS
- **可配置**：支持不同的构建配置
- **依赖管理**：自动管理依赖关系
- **可扩展**：易于添加新的构建目标和配置

## 2. 构建工具

### 2.1 核心工具

| 工具 | 版本 | 用途 | 安装命令 |
|------|------|------|----------|
| CMake | 3.16+ | 构建系统生成器 | [官网下载](https://cmake.org/download/) |
| Ninja | 1.10+ | 快速构建工具 | `choco install ninja` (Windows) / `apt install ninja-build` (Linux) / `brew install ninja` (macOS) |
| LLVM | 18.0+ | 代码生成和优化 | [官网下载](https://llvm.org/releases/download.html) |
| Clang | 18.0+ | C/C++ 编译器 | 随LLVM一起安装 |

### 2.2 辅助工具

- **ccache**：缓存编译结果，加速重复构建
- **clazy**：Clang静态分析器
- **scan-build**：Clang静态分析工具

## 3. 构建系统架构

### 3.1 构建系统层次

```
┌────────────────┐
│  CMakeLists.txt │  # 顶层配置
├────────────────┤
│  src/CMakeLists.txt │  # 源代码配置
├────────────────┤
│  lib/CMakeLists.txt │  # 标准库配置
├────────────────┤
│  tests/CMakeLists.txt │  # 测试配置
└────────────────┘
```

### 3.2 构建目录结构

```
build/           # 构建目录
├── Debug/       # Debug配置
├── Release/     # Release配置
├── RelWithDebInfo/ # 带调试信息的Release配置
└── MinSizeRel/  # 最小尺寸配置
```

## 4. 构建配置

### 4.1 构建类型

| 类型 | 描述 | 优化级别 | 调试信息 | 适用场景 |
|------|------|----------|----------|----------|
| Debug | 调试配置 | 无 | 完整 | 开发 |
| Release | 发布配置 | 高 | 无 | 生产 |
| RelWithDebInfo | 带调试信息的发布配置 | 高 | 完整 | 调试生产问题 |
| MinSizeRel | 最小尺寸配置 | 代码大小 | 无 | 空间受限环境 |

### 4.2 配置选项

| 选项 | 描述 | 默认值 | 可选值 |
|------|------|--------|--------|
| CMAKE_BUILD_TYPE | 构建类型 | Debug | Debug, Release, RelWithDebInfo, MinSizeRel |
| LLVM_DIR | LLVM安装目录 | 自动检测 | LLVM安装路径 |
| Clang_DIR | Clang安装目录 | 自动检测 | Clang安装路径 |
| BUILD_TESTS | 构建测试 | ON | ON, OFF |
| BUILD_EXAMPLES | 构建示例 | ON | ON, OFF |
| BUILD_DOCS | 构建文档 | OFF | ON, OFF |
| ENABLE_COVERAGE | 启用覆盖分析 | OFF | ON, OFF |
| ENABLE_ADDRESS_SANITIZER | 启用地址 sanitizer | OFF | ON, OFF |
| ENABLE_THREAD_SANITIZER | 启用线程 sanitizer | OFF | ON, OFF |
| ENABLE_UNDEFINED_SANITIZER | 启用未定义行为 sanitizer | OFF | ON, OFF |

### 4.3 配置命令

#### 4.3.1 Windows (Visual Studio)

```powershell
# Debug配置
cmake -B build\Debug -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Debug

# Release配置
cmake -B build\Release -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release
```

#### 4.3.2 Linux/macOS (Ninja)

```bash
# Debug配置
cmake -B build/Debug -G Ninja -DCMAKE_BUILD_TYPE=Debug

# Release配置
cmake -B build/Release -G Ninja -DCMAKE_BUILD_TYPE=Release
```

## 5. 构建流程

### 5.1 基本流程

1. **配置**：运行CMake生成构建系统
2. **编译**：编译源代码
3. **链接**：链接目标文件
4. **测试**：运行测试
5. **安装**：安装构建产物

### 5.2 构建命令

#### 5.2.1 Windows (Visual Studio)

```powershell
# 构建Debug配置
cmake --build build\Debug

# 构建Release配置
cmake --build build\Release

# 构建特定目标
cmake --build build\Debug --target c_hat_parser
```

#### 5.2.2 Linux/macOS (Ninja)

```bash
# 构建Debug配置
cmake --build build/Debug

# 构建Release配置
cmake --build build/Release

# 构建特定目标
cmake --build build/Debug --target c_hat_parser
```

### 5.3 构建目标

| 目标 | 描述 | 命令 |
|------|------|------|
| c_hat_parser | 编译器可执行文件 | `cmake --build build --target c_hat_parser` |
| unit_tests | 单元测试 | `cmake --build build --target unit_tests` |
| integration_tests | 集成测试 | `cmake --build build --target integration_tests` |
| e2e_tests | 端到端测试 | `cmake --build build --target e2e_tests` |
| performance_tests | 性能测试 | `cmake --build build --target performance_tests` |
| fuzz_tests | 模糊测试 | `cmake --build build --target fuzz_tests` |
| docs | 文档 | `cmake --build build --target docs` |
| install | 安装 | `cmake --build build --target install` |

## 6. 依赖管理

### 6.1 内部依赖

- **AST**：抽象语法树
- **Lexer**：词法分析器
- **Parser**：语法分析器
- **Type System**：类型系统
- **Semantic Analysis**：语义分析
- **Code Generation**：代码生成
- **Optimization**：优化

### 6.2 外部依赖

| 依赖 | 版本 | 用途 | 管理方式 |
|------|------|------|----------|
| LLVM | 18.0+ | 代码生成和优化 | 系统安装或包管理器 |
| Clang | 18.0+ | C/C++ 编译器 | 系统安装或包管理器 |
| GoogleTest | 1.14+ | 单元测试 | Git子模块或包管理器 |
| Doxygen | 1.9+ | 文档生成 | 系统安装或包管理器 |

### 6.3 依赖配置

#### 6.3.1 LLVM依赖配置

```cmake
# 查找LLVM
find_package(LLVM 18.0 REQUIRED CONFIG)

# 包含LLVM头文件
include_directories(${LLVM_INCLUDE_DIRS})
add_definitions(${LLVM_DEFINITIONS})

# 链接LLVM库
llvm_map_components_to_libnames(LLVM_LIBS core support)
target_link_libraries(c_hat_parser ${LLVM_LIBS})
```

#### 6.3.2 GoogleTest依赖配置

```cmake
# 查找GoogleTest
find_package(GTest REQUIRED)

# 包含GoogleTest头文件
include_directories(${GTEST_INCLUDE_DIRS})

# 链接GoogleTest库
target_link_libraries(unit_tests ${GTEST_LIBRARIES} pthread)
```

## 7. 构建优化

### 7.1 并行构建

- **Windows**：使用Visual Studio的并行构建功能
- **Linux/macOS**：使用Ninja或`make -jN`

### 7.2 增量构建

- **CMake**：自动处理增量构建
- **ccache**：缓存编译结果，加速重复构建

### 7.3 编译优化

- **预编译头**：使用预编译头加速编译
- **统一编译**：使用统一编译减少编译时间
- **链接时间优化**：在Release配置中启用LTO

### 7.4 构建缓存

- **ccache**：缓存编译结果
- **CMake缓存**：缓存CMake配置

## 8. 跨平台构建

### 8.1 Windows

- **编译器**：Visual Studio 2022
- **构建工具**：MSBuild
- **配置**：使用`-G "Visual Studio 17 2022" -A x64`

### 8.2 Linux

- **编译器**：Clang 18.0+
- **构建工具**：Ninja
- **配置**：使用`-G Ninja`

### 8.3 macOS

- **编译器**：Clang 18.0+
- **构建工具**：Ninja
- **配置**：使用`-G Ninja`

## 9. 构建系统扩展

### 9.1 添加新的源代码目录

```cmake
# 在src/CMakeLists.txt中添加
add_subdirectory(new_module)
```

### 9.2 添加新的构建目标

```cmake
# 添加新的可执行文件
add_executable(new_tool new_tool.cpp)
target_link_libraries(new_tool c_hat_core)

# 添加新的库
add_library(new_lib STATIC new_lib.cpp)
target_include_directories(new_lib PUBLIC include)
```

### 9.3 添加新的测试

```cmake
# 在tests/CMakeLists.txt中添加
add_executable(new_test new_test.cpp)
target_link_libraries(new_test c_hat_core ${GTEST_LIBRARIES})
add_test(NAME new_test COMMAND new_test)
```

## 10. 构建系统维护

### 10.1 构建系统更新

- **CMake版本更新**：定期更新CMake版本以获取新功能
- **依赖版本更新**：定期更新依赖版本以获取bug修复和新功能

### 10.2 构建系统故障排除

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| CMake无法找到LLVM | LLVM未安装或路径错误 | 安装LLVM或使用`-DLLVM_DIR`指定路径 |
| 编译错误 | 依赖版本不兼容或代码错误 | 检查依赖版本或修复代码错误 |
| 链接错误 | 缺少库或符号 | 检查库依赖或修复符号问题 |
| 构建缓慢 | 缺少并行构建或缓存 | 使用并行构建或启用ccache |

### 10.3 构建系统最佳实践

- **模块化**：将构建系统分解为多个模块
- **可配置性**：使用CMake变量控制构建行为
- **文档**：为构建系统添加注释和文档
- **测试**：测试构建系统在不同平台和配置下的行为

## 11. 构建系统实施

### 11.1 阶段一：基础构建系统

- **目标**：建立基础构建系统
- **范围**：编译器核心
- **完成标准**：能够编译基本的编译器可执行文件

### 11.2 阶段二：完整构建系统

- **目标**：构建完整的编译器和标准库
- **范围**：编译器核心、标准库、测试
- **完成标准**：能够编译完整的编译器、标准库和测试

### 11.3 阶段三：优化构建系统

- **目标**：优化构建系统性能和可靠性
- **范围**：构建系统优化、跨平台支持
- **完成标准**：构建系统在所有平台上都能高效运行

## 12. 总结

C^语言的构建系统采用CMake作为构建系统生成器，Ninja或MSBuild作为构建工具，支持跨平台构建和多种构建配置。构建系统管理项目的编译、链接和依赖关系，确保编译器能够在不同平台和配置下正确构建。

通过合理的构建系统设计和优化，可以显著提高编译速度和开发效率，确保编译器的质量和可靠性。同时，构建系统的可扩展性和可维护性也确保了项目能够随着功能的增加而不断发展。

---

*文档版本：1.0.0*
*最后更新：2026-02-05*
